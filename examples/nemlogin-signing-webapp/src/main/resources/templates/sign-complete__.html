<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:include="fragments/layout :: headFragment"></head>
<body>
<!--/*@thymesVar id="format" type="String"*/-->
<!--/*@thymesVar id="name" type="String"*/-->
<!--/*@thymesVar id="correlationId" type="String"*/-->
<!--/*@thymesVar id="signedDocumentFilename" type="String"*/-->
<!--/*@thymesVar id="signedDocument" type="String"*/-->
<!--/*@thymesVar id="validationReport" type="dk.gov.nemlogin.signing.validation.model.ValidationReport"*/-->
<script th:inline="javascript">

  /** Convert Bas64-encoded document to a Blob **/
  function b64toBlob(b64Data, contentType, sliceSize) {
    sliceSize = sliceSize || 512;
    const byteCharacters = atob(b64Data);
    const byteArrays = [];

    for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
      const slice = byteCharacters.slice(offset, offset + sliceSize);
      const byteNumbers = new Array(slice.length);
      for (let i = 0; i < slice.length; i++) {
        byteNumbers[i] = slice.charCodeAt(i);
      }
      const byteArray = new Uint8Array(byteNumbers);
      byteArrays.push(byteArray);
    }
    return  new Blob(byteArrays, {type: contentType});
  }


  /** Save the signed document **/
  function save() {
	debugger;
    const data = document.signingResult.result.value;
    const mediaType = /*[[${mediaType}]]*/ {};
    const fileName = /*[[${signedDocumentFilename}]]*/ {};
    const blob = b64toBlob(data, mediaType);
    if (window.navigator.msSaveOrOpenBlob) {
      // IE specific download.
      navigator.msSaveBlob(blob, fileName);
    } else {
      const downloadLink = document.createElement("a");
      downloadLink.style.display = "none";
      document.body.appendChild(downloadLink);
      downloadLink.setAttribute("href", window.URL.createObjectURL(blob));
      downloadLink.setAttribute("download", fileName);
      downloadLink.click();
      document.body.removeChild(downloadLink);
    }
  }
</script>
<div>
  <div class="container page-layout">
    <div th:replace="fragments/layout :: headerFragment"></div>

    <div class="page-content">

      <div class="mb-3">
        <span style="float: right">
          <a href="/" class="btn btn-secondary" th:text="#{back}" id="back"></a>
        </span>
        <span style="float: right" class="mr-2">
          <a th:href="@{|/sign/${format}/${name}?correlationId=${newCorrelationId}|}" class="btn btn-secondary" th:text="#{sign_complete.sign_again}"
             id="sign-again"></a>
        </span>
        <h2 th:text="#{sign_complete.title}"></h2>
      </div>

      <div class="text-center m-5">
        <form action="/validate-signing-result" name="signingResult" method="post">
          <div class="card bg-light" style="width: 400px; margin: 0 auto;">
            <div class="card-header">
              <h4 th:text="${signedDocumentFilename}"></h4>
            </div>
            <div class="card-body text-left">
              <button type="button" class="btn btn-outline-secondary" onclick="save()" id="save-document">
                <i class="fas fa-file-download"></i>
                <span th:text="#{sign_complete.download}"></span>
              </button>
              <button type="submit" class="btn btn-outline-secondary float-right" id="validate-document">
                <i class="fas fa-check-circle"></i>
                <span th:text="#{sign_complete.validate}"></span>
              </button>
              <input type="hidden" name="result" th:value="${signedDocument}">
              <input type="hidden" name="name" th:value="${name}">
              <input type="hidden" name="format" th:value="${format}">
              <input type="hidden" name="correlationId" th:value="${correlationId}">
            </div>
          </div>
        </form>
      </div>

      <div th:if="${validationReport} != null" class="card text-center mt-5">
        <div class="card-header">
          <ul class="nav nav-tabs card-header-tabs" role="tablist">
            <li class="nav-item">
              <a class="nav-link active" data-toggle="tab" href="#validationResult" role="tab" id="validation-result"
                 th:text="#{sign_complete.report.result}"></a>
            </li>
            <li class="nav-item">
              <a class="nav-link" data-toggle="tab" href="#etsiReport" role="tab" id="etsi-report"
                 th:text="#{sign_complete.report.etsi}"></a>
            </li>
          </ul>
        </div>
        <div class="card-body">
          <div class="tab-content text-left validation-result">

            <!-- Validation Result -->
            <div id="validationResult" class="tab-pane fade show active" role="tabpanel">
              <table class="table mt-4" th:if="${not #lists.isEmpty(validationReport.result.signatures)} != null"
                     th:each="signature : ${validationReport.result.signatures}">
                <th:block th:if="${signature.indication} != null" th:switch="${signature.indication}">
                  <tr th:case="${T(dk.gov.nemlogin.signing.validation.model.ValidationSignature.Indication).TOTAL_FAILED}"
                      style="background-color: red;">
                    <th th:text="#{sign_complete.report.result.indication}"></th>
                    <td th:text="#{sign_complete.report.result.indication.failed}"></td>
                  </tr>
                  <tr th:case="${T(dk.gov.nemlogin.signing.validation.model.ValidationSignature.Indication).INDETERMINATE}"
                      style="background-color: orange;">
                    <th th:text="#{sign_complete.report.result.indication}"></th>
                    <td th:text="#{sign_complete.report.result.indication.indeterminate}"></td>
                  </tr>
                  <tr th:case="${T(dk.gov.nemlogin.signing.validation.model.ValidationSignature.Indication).TOTAL_PASSED}"
                      style="background-color: green;">
                    <th th:text="#{sign_complete.report.result.indication}"></th>
                    <td th:text="#{sign_complete.report.result.indication.passed}"></td>
                  </tr>
                </th:block>
                <tr th:if="${signature.signatureFormat} != null">
                  <th th:text="#{sign_complete.report.result.format}"></th>
                  <td th:text="${signature.signatureFormat}"></td>
                </tr>
                <tr th:if="${signature.signatureLevel} != null">
                  <th th:text="#{sign_complete.report.result.level}"></th>
                  <td th:text="${signature.signatureLevel}"></td>
                </tr>
                <tr th:if="${signature.signingTime} != null">
                  <th th:text="#{sign_complete.report.result.signing_time}"></th>
                  <td th:text="${signature.signingTime}"></td>
                </tr>
                <tr th:if="${signature.signedBy} != null">
                  <th th:text="#{sign_complete.report.result.signed_by}"></th>
                  <td th:text="${signature.signedBy}"></td>
                </tr>
                <tr th:if="${signature.email} != null">
                  <th th:text="#{sign_complete.report.result.email}"></th>
                  <td th:text="${signature.email}"></td>
                </tr>
                <tr th:if="${not #lists.isEmpty(signature.certificateChain)} != null"
                    th:each="certificate, iter : ${signature.certificateChain}">
                  <th th:switch="${iter.index}">
                    <span th:case="0" th:text="#{sign_complete.report.result.signing_cert}"></span>
                    <span th:case="1" th:text="#{sign_complete.report.result.issuing_ca}"></span>
                    <span th:case="*" th:text="#{sign_complete.report.result.issued_by}"></span>
                  </th>
                  <td>
                    <div th:text="${certificate.subjectDN}"></div>
                    <div th:if="${iter.index} == 0">
                      <div>
                        <span th:text="#{sign_complete.report.result.serial_number}"></span>:&nbsp;
                        <span th:text="${certificate.serialNumber}"></span>
                      </div>
                      <div>
                        <span th:text="#{sign_complete.report.result.valid_period}"></span>:&nbsp;
                        <span th:if="${certificate.notBefore != null}" th:text="${certificate.notBefore}"></span>&nbsp;-&nbsp;
                        <span th:if="${certificate.notAfter != null}" th:text="${certificate.notAfter}"></span>
                      </div>
                      <div th:if="${not #lists.isEmpty(certificate.policies)} != null">
                        <span th:text="#{sign_complete.report.result.policies}"></span>:&nbsp;
                        <span th:each="policy, iterPolicy : ${certificate.policies}"
                              th:text="!${iterPolicy.last} ? ${policy} + ', ' : ${policy}"></span>
                      </div>
                    </div>
                  </td>
                </tr>
                <tr th:if="${not #lists.isEmpty(signature.errors)} != null" th:each="error : ${signature.errors}">
                  <th th:text="#{sign_complete.report.result.error}"></th>
                  <td th:text="${error}"></td>
                </tr>
                <tr th:if="${not #lists.isEmpty(signature.warnings)} != null" th:each="warning : ${signature.warnings}">
                  <th th:text="#{sign_complete.report.result.warning}"></th>
                  <td th:text="${warning}"></td>
                </tr>
                <tr th:if="${not #lists.isEmpty(signature.infos)} != null" th:each="info : ${signature.infos}">
                  <th th:text="#{sign_complete.report.result.info}"></th>
                  <td th:text="${info}"></td>
                </tr>
              </table>
            </div>

            <!-- ETSI Report -->
            <div id="etsiReport" class="tab-pane fade" role="tabpanel">
              <pre><code class="language-xml" th:text="${validationReport.etsiReport}"></code></pre>
            </div>
          </div>
        </div>
      </div>


    </div>

    <div th:replace="fragments/layout :: footerFragment"></div>
  </div>
</div>
</body>
</html>
